<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>News table</title>
  <style>
    :root {
      --max-width: 500px;
      --cat-min: 50px;
      --time-min: 50px;
    }

    body {
      font-family: Arial, Helvetica, sans-serif;
      padding: 10px;
      display: flex;
      justify-content: center;
      background: #fff;
    }

    .wrap {
      width: 100%;
      max-width: var(--max-width);
    }

    table.news-table {
      width: 100%;
      border-collapse: collapse;
      table-layout: auto; /* allow flexible columns */
    }

    table.news-table col.col-cat { min-width: var(--cat-min); }
    table.news-table col.col-time { min-width: var(--time-min); }
    table.news-table col.col-head { /* flexible */ }

    table.news-table td {
      border: 1px solid #ddd;
      padding: 6px 8px;
      vertical-align: middle;
      word-wrap: break-word;
      overflow-wrap: anywhere;
    }

    /* First merged row style (site name) */
    td.site-name {
      text-align: center;
      font-style: italic;
      font-weight: 800;
      text-transform: lowercase;
      padding: 10px;
      background: #fafafa;
      font-size: 16px;
    }

    /* category column */
    td.cat-cell {
      text-align: center;
      font-weight: 600;
      white-space: nowrap; /* prevent wrap for 'Derivative' / 'Stock' */
      background: #f6f6f6;
    }

    /* time column */
    td.time-cell {
      white-space: nowrap; /* keep time on one line */
      font-size: 10px; /* slightly smaller */
      text-align: center;
    }

    /* headline column */
    td.head-cell {
      font-size: 13px;
      padding-left: 10px;
    }

    /* separator row */
    tr.separator-row td {
      padding: 0;
      height: 2px;
      background: #b2d5ff; /* thin blue divider */
      border: none;
    }

    /* zebra classes (applied by JS) */
    tr.news-odd td { background: #ffffff; }
    tr.news-even td { background: #fbfbfb; }

    /* small screens */
    @media (max-width: 520px) {
      .wrap { padding: 0 6px; }
      td.head-cell { font-size: 12px; }
      td.time-cell { font-size: 10px; }
      td.site-name { font-size: 13px; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <table class="news-table" aria-label="news table">
      <colgroup>
        <col class="col-cat">
        <col class="col-time">
        <col class="col-head">
      </colgroup>

      <!-- Row 1: merged site name -->
      <tr>
        <td class="site-name" colspan="3">jayfromstockmarketsinindia.blogspot.com</td>
      </tr>

      <tbody id="newsBody">
        <!-- JS will populate 10 rows (4 derivative + separator + 6 stock) -->
      </tbody>
    </table>
  </div>

  <script>
    // Format raw dates (examples handled: "Nov-22-2025 16:59", "Nov-22-2025   16:59 Hrs IST", ISO strings, etc.)
    function formatToDDMMYYYY_HHMM(raw) {
      if (!raw) return "";
      raw = String(raw).replace(/\u00A0/g, " ").replace(/Hrs?\.?\s*IST/i, "").trim();

      // Match "Nov-22-2025 16:59" or "Nov-22-2025   16:59"
      let m = raw.match(/^([A-Za-z]{3})[-\s]?(\d{1,2})[-\s]?(\d{4})\s+(\d{1,2}):(\d{2})/);
      const months = { Jan:"01",Feb:"02",Mar:"03",Apr:"04",May:"05",Jun:"06",Jul:"07",Aug:"08",Sep:"09",Oct:"10",Nov:"11",Dec:"12" };
      if (m) {
        const mon = months[m[1]] || "01";
        const day = String(m[2]).padStart(2,"0");
        const yr = m[3];
        const hh = String(m[4]).padStart(2,"0");
        const mm = String(m[5]).padStart(2,"0");
        return `${day}-${mon}-${yr} ${hh}:${mm} hrs.`;
      }

      // Match DD-MM-YYYY HH:MM
      m = raw.match(/^(\d{1,2})[-\/](\d{1,2})[-\/](\d{4})\s+(\d{1,2}):(\d{2})/);
      if (m) {
        const day = String(m[1]).padStart(2,"0");
        const mon = String(m[2]).padStart(2,"0");
        const yr = m[3];
        const hh = String(m[4]).padStart(2,"0");
        const mm = String(m[5]).padStart(2,"0");
        return `${day}-${mon}-${yr} ${hh}:${mm} hrs.`;
      }

      // Fallback: try Date parse
      const dt = new Date(raw);
      if (!isNaN(dt)) {
        const dd = String(dt.getDate()).padStart(2,"0");
        const mo = String(dt.getMonth()+1).padStart(2,"0");
        const yy = dt.getFullYear();
        const hh = String(dt.getHours()).padStart(2,"0");
        const mins = String(dt.getMinutes()).padStart(2,"0");
        return `${dd}-${mo}-${yy} ${hh}:${mins} hrs.`;
      }

      // Last resort
      return raw + " hrs.";
    }

    // Render table with 4 derivative and 6 stock rows, add separator row, apply zebra by JS
    function renderTable(derivativeArr, generalArr) {
      const tbody = document.getElementById("newsBody");
      tbody.innerHTML = "";

      const derivative = (derivativeArr || []).slice(0,4);
      const general = (generalArr || []).slice(0,6);

      // pad to required lengths
      while (derivative.length < 4) derivative.push({ date: "", headline: "" });
      while (general.length < 6) general.push({ date: "", headline: "" });

      const createdRows = [];

      // Derivative block (4 rows) - first row includes merged category cell
      for (let i = 0; i < 4; i++) {
        const tr = document.createElement("tr");
        tr.classList.add("news-row");
        if (i === 0) {
          const tdCat = document.createElement("td");
          tdCat.className = "cat-cell";
          tdCat.rowSpan = 4;
          tdCat.textContent = "Derivative";
          tr.appendChild(tdCat);
        }
        const tdTime = document.createElement("td");
        tdTime.className = "time-cell";
        tdTime.textContent = formatToDDMMYYYY_HHMM(derivative[i].date || "");
        tr.appendChild(tdTime);

        const tdHead = document.createElement("td");
        tdHead.className = "head-cell";
        tdHead.textContent = derivative[i].headline || "";
        tr.appendChild(tdHead);

        tbody.appendChild(tr);
        createdRows.push(tr);
      }

      // Separator row between derivative and stock
      const sep = document.createElement("tr");
      sep.className = "separator-row";
      const sepTd = document.createElement("td");
      sepTd.colSpan = 3;
      sep.appendChild(sepTd);
      tbody.appendChild(sep);

      // Stock block (6 rows) - first row includes merged category cell
      for (let i = 0; i < 6; i++) {
        const tr = document.createElement("tr");
        tr.classList.add("news-row");
        if (i === 0) {
          const tdCat = document.createElement("td");
          tdCat.className = "cat-cell";
          tdCat.rowSpan = 6;
          tdCat.textContent = "Stock";
          tr.appendChild(tdCat);
        }
        const tdTime = document.createElement("td");
        tdTime.className = "time-cell";
        tdTime.textContent = formatToDDMMYYYY_HHMM(general[i].date || "");
        tr.appendChild(tdTime);

        const tdHead = document.createElement("td");
        tdHead.className = "head-cell";
        tdHead.textContent = general[i].headline || "";
        tr.appendChild(tdHead);

        tbody.appendChild(tr);
        createdRows.push(tr);
      }

      // Apply zebra striping only to createdRows (so separator & site row ignored)
      createdRows.forEach((r, idx) => {
        r.classList.remove("news-even", "news-odd");
        if (idx % 2 === 0) r.classList.add("news-odd");
        else r.classList.add("news-even");
      });
    }

    // Fetch data from your server /news endpoint and render
    async function fetchAndRender() {
      try {
        const resp = await fetch("/news");
        if (!resp.ok) throw new Error("Network error " + resp.status);
        const json = await resp.json();

        // server returns { derivative: [...], general: [...] }
        const derivative = json.derivative || [];
        const general = json.general || [];

        renderTable(derivative, general);
      } catch (err) {
        console.error("Fetch/render error:", err);
        // On error, render empty table with merged category cells (still shows labels)
        renderTable([], []);
      }
    }

    // initial load + 30 min refresh
    fetchAndRender();
    setInterval(fetchAndRender, 30 * 60 * 1000);
  </script>
</body>
</html>
