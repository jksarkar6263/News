<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>News table</title>
  <style>
    :root {
      --max-width: 500px;
      --cat-min: 50px;
      --time-min: 50px;
    }

    body {
      font-family: Arial, Helvetica, sans-serif;
      padding: 10px;
      display: flex;
      justify-content: center;
      background: #fff;
    }

    .wrap {
      width: 100%;
      max-width: var(--max-width);
    }

    table.news-table {
      width: 100%;
      border-collapse: collapse;
      table-layout: auto;
    }

    table.news-table col.col-cat { min-width: var(--cat-min); }
    table.news-table col.col-time { min-width: var(--time-min); }
    table.news-table col.col-head {}

    table.news-table td {
      border: 1px solid #ddd;
      padding: 6px 8px;
      vertical-align: middle;
      word-wrap: break-word;
      overflow-wrap: anywhere;
    }

    td.site-name {
      text-align: center;
      font-style: italic;
      font-weight: 800;
      text-transform: lowercase;
      padding: 10px;
      background: #fafafa;
      font-size: 16px;
    }

    td.cat-cell {
      text-align: center;
      font-weight: 600;
      white-space: nowrap;
      background: #f6f6f6;
    }

    td.time-cell {
      white-space: nowrap;
      font-size: 10px;
      text-align: center;
    }

    td.head-cell {
      font-size: 13px;
      padding-left: 10px;
    }

    tr.separator-row td {
      padding: 0;
      height: 2px;
      background: #b2d5ff;
      border: none;
    }

    tr.news-odd td { background: #ffffff; }
    tr.news-even td { background: #fbfbfb; }

    @media (max-width: 520px) {
      .wrap { padding: 0 6px; }
      td.head-cell { font-size: 12px; }
      td.time-cell { font-size: 10px; }
      td.site-name { font-size: 13px; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <table class="news-table" aria-label="news table">
      <colgroup>
        <col class="col-cat">
        <col class="col-time">
        <col class="col-head">
      </colgroup>

      <tr>
        <td class="site-name" colspan="3">
          jayfromstockmarketsinindia.blogspot.com
        </td>
      </tr>

      <tbody id="newsBody"></tbody>
    </table>
  </div>

  <script>
    function formatToDDMMYYYY_HHMM(raw) {
      if (!raw) return "";
      raw = String(raw).replace(/\u00A0/g, " ")
                       .replace(/Hrs?\.?\s*IST/i, "")
                       .trim();

      let m = raw.match(/^([A-Za-z]{3})[-\s]?(\d{1,2})[-\s]?(\d{4})\s+(\d{1,2}):(\d{2})/);
      const months = {Jan:"01",Feb:"02",Mar:"03",Apr:"04",May:"05",Jun:"06",Jul:"07",
                      Aug:"08",Sep:"09",Oct:"10",Nov:"11",Dec:"12"};
      if (m) {
        return `${String(m[2]).padStart(2,"0")}-${months[m[1]]}-${m[3]} `
             + `${String(m[4]).padStart(2,"0")}:${m[5]} hrs.`;
      }

      m = raw.match(/^(\d{1,2})[-\/](\d{1,2})[-\/](\d{4})\s+(\d{1,2}):(\d{2})/);
      if (m) {
        return `${String(m[1]).padStart(2,"0")}-${String(m[2]).padStart(2,"0")}-${m[3]} `
             + `${String(m[4]).padStart(2,"0")}:${m[5]} hrs.`;
      }

      const dt = new Date(raw);
      if (!isNaN(dt)) {
        return `${String(dt.getDate()).padStart(2,"0")}-`
             + `${String(dt.getMonth()+1).padStart(2,"0")}-`
             + `${dt.getFullYear()} `
             + `${String(dt.getHours()).padStart(2,"0")}:`
             + `${String(dt.getMinutes()).padStart(2,"0")} hrs.`;
      }

      return raw + " hrs.";
    }

    function renderTable(derivativeArr, generalArr) {
      const tbody = document.getElementById("newsBody");
      tbody.innerHTML = "";

      const d = (derivativeArr || []).slice(0,4);
      const g = (generalArr || []).slice(0,6);

      while (d.length < 4) d.push({date:"", headline:""});
      while (g.length < 6) g.push({date:"", headline:""});

      const rows = [];

      for (let i = 0; i < 4; i++) {
        const tr = document.createElement("tr");
        tr.classList.add("news-row");
        if (i === 0) {
          const tdCat = document.createElement("td");
          tdCat.className = "cat-cell";
          tdCat.rowSpan = 4;
          tdCat.textContent = "Derivative";
          tr.appendChild(tdCat);
        }
        const tdTime = document.createElement("td");
        tdTime.className = "time-cell";
        tdTime.textContent = formatToDDMMYYYY_HHMM(d[i].date);
        tr.appendChild(tdTime);

        const tdHead = document.createElement("td");
        tdHead.className = "head-cell";
        tdHead.textContent = d[i].headline || "";
        tr.appendChild(tdHead);

        tbody.appendChild(tr);
        rows.push(tr);
      }

      const sep = document.createElement("tr");
      sep.className = "separator-row";
      const sepTd = document.createElement("td");
      sepTd.colSpan = 3;
      sep.appendChild(sepTd);
      tbody.appendChild(sep);

      for (let i = 0; i < 6; i++) {
        const tr = document.createElement("tr");
        tr.classList.add("news-row");
        if (i === 0) {
          const tdCat = document.createElement("td");
          tdCat.className = "cat-cell";
          tdCat.rowSpan = 6;
          tdCat.textContent = "Stock";
          tr.appendChild(tdCat);
        }
        const tdTime = document.createElement("td");
        tdTime.className = "time-cell";
        tdTime.textContent = formatToDDMMYYYY_HHMM(g[i].date);
        tr.appendChild(tdTime);

        const tdHead = document.createElement("td");
        tdHead.className = "head-cell";
        tdHead.textContent = g[i].headline || "";
        tr.appendChild(tdHead);

        tbody.appendChild(tr);
        rows.push(tr);
      }

      rows.forEach((r,i)=>{
        r.classList.remove("news-even","news-odd");
        r.classList.add(i % 2 === 0 ? "news-odd" : "news-even");
      });
    }

    async function loadNews() {
      try {
        const res = await fetch("/news");
        if (!res.ok) throw new Error("Network error");
        const json = await res.json();

        renderTable(json.derivative || [], json.general || []);
      } catch (e) {
        console.error("Failed:", e);
        renderTable([],[]);
      }
    }

    loadNews();
    setInterval(loadNews, 30*60*1000);
  </script>
</body>
</html>
